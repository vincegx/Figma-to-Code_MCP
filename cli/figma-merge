#!/bin/bash

set -e

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Display banner
clear
echo ""
echo -e "${MAGENTA}"
cat << "EOF"
 ____                               _                __  __
|  _ \ ___  ___ _ __   ___  _ __  ___(_)_   _____   |  \/  | ___ _ __ __ _  ___ _ __
| |_) / _ \/ __| '_ \ / _ \| '_ \/ __| \ \ / / _ \  | |\/| |/ _ \ '__/ _` |/ _ \ '__|
|  _ <  __/\__ \ |_) | (_) | | | \__ \ |\ V /  __/  | |  | |  __/ | | (_| |  __/ |
|_| \_\___||___/ .__/ \___/|_| |_|___/_| \_/ \___|  |_|  |_|\___|_|  \__, |\___|_|
               |_|                                                    |___/
EOF
echo -e "${NC}"

echo -e "${BOLD}${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${BOLD}  Responsive Merger${NC} - Fusion de 3 breakpoints en composants responsives"
echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""
echo -e "  ${CYAN}üì¶ Fonctionnalit√©s :${NC}"
echo -e "     ‚Ä¢ Merge 3 tests Figma (Desktop, Tablet, Mobile) en composants responsives"
echo -e "     ‚Ä¢ G√©n√®re media queries CSS automatiques (@media)"
echo -e "     ‚Ä¢ Pr√©serve la structure parent/containers des designs Figma"
echo -e "     ‚Ä¢ Copie et organise les images pour les subcomposants"
echo -e "     ‚Ä¢ 100% CSS-only (pas de logic swap de composants)"
echo ""
echo -e "  ${YELLOW}‚ö° Strat√©gie :${NC}"
echo -e "     ‚Ä¢ Desktop = Base styles (no media query)"
echo -e "     ‚Ä¢ Tablet  = Overrides @media (max-width: XXXpx)"
echo -e "     ‚Ä¢ Mobile  = Overrides @media (max-width: XXXpx)"
echo ""
echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""

# Check arguments
if [ "$#" -ne 6 ]; then
  echo -e "${RED}‚ùå Arguments manquants${NC}"
  echo ""
  echo "Usage: ./figma-merge <desktop-width> <desktop-test-id> <tablet-width> <tablet-test-id> <mobile-width> <mobile-test-id>"
  echo ""
  echo "Exemple:"
  echo "  ./figma-merge 1440px node-6055-2436-1762733564 960px node-6055-2654-1762712319 420px node-6055-2872-1762733537"
  echo ""
  echo "Arguments:"
  echo "  --desktop <width> <test-id>  : Desktop breakpoint (ex: 1440px node-6055-2436-...)"
  echo "  --tablet  <width> <test-id>  : Tablet breakpoint (ex: 960px node-6055-2654-...)"
  echo "  --mobile  <width> <test-id>  : Mobile breakpoint (ex: 420px node-6055-2872-...)"
  exit 1
fi

DESKTOP_WIDTH="$1"
DESKTOP_ID="$2"
TABLET_WIDTH="$3"
TABLET_ID="$4"
MOBILE_WIDTH="$5"
MOBILE_ID="$6"

# Check Docker container is running
if ! docker ps | grep -q mcp-figma-v1; then
  echo -e "${YELLOW}‚ö†Ô∏è  Container Docker non lanc√©${NC}"
  echo ""
  echo "Lancement du container..."
  docker-compose up -d

  # Wait for container to be ready
  echo "Attente du d√©marrage (10s)..."
  sleep 10
fi

# Get absolute project path
PROJECT_ROOT="$(cd "$(dirname "$0")/.." && pwd)"

# Run responsive-merger.js in Docker
echo -e "${GREEN}üöÄ Lancement du Responsive Merger dans Docker...${NC}"
echo ""

docker exec -e "PROJECT_ROOT=$PROJECT_ROOT" mcp-figma-v1 node scripts/responsive-merger.js \
  --desktop "$DESKTOP_WIDTH" "$DESKTOP_ID" \
  --tablet "$TABLET_WIDTH" "$TABLET_ID" \
  --mobile "$MOBILE_WIDTH" "$MOBILE_ID"

exit_code=$?

if [ $exit_code -eq 0 ]; then
  echo -e "${GREEN}‚úÖ Merge termin√© avec succ√®s${NC}"
else
  echo -e "${RED}‚ùå Erreur lors du merge (code: $exit_code)${NC}"
  exit $exit_code
fi
