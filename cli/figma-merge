#!/bin/bash

set -e

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Display banner
clear
echo ""
echo -e "${MAGENTA}"
cat << "EOF"
 ____                               _                __  __
|  _ \ ___  ___ _ __   ___  _ __  ___(_)_   _____   |  \/  | ___ _ __ __ _  ___ _ __
| |_) / _ \/ __| '_ \ / _ \| '_ \/ __| \ \ / / _ \  | |\/| |/ _ \ '__/ _` |/ _ \ '__|
|  _ <  __/\__ \ |_) | (_) | | | \__ \ |\ V /  __/  | |  | |  __/ | | (_| |  __/ |
|_| \_\___||___/ .__/ \___/|_| |_|___/_| \_/ \___|  |_|  |_|\___|_|  \__, |\___|_|
               |_|                                                    |___/
EOF
echo -e "${NC}"

echo -e "${BOLD}${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${BOLD}  Responsive Merger${NC} - Merge 3 breakpoints into responsive components"
echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""
echo -e "  ${CYAN}üì¶ Features:${NC}"
echo -e "     ‚Ä¢ Merge 3 Figma exports (Desktop, Tablet, Mobile) into responsive components"
echo -e "     ‚Ä¢ Generate automatic CSS media queries (@media)"
echo -e "     ‚Ä¢ Preserve parent/container structure from Figma designs"
echo -e "     ‚Ä¢ Copy and organize images for subcomponents"
echo -e "     ‚Ä¢ 100% CSS-only (no component swapping logic)"
echo ""
echo -e "  ${YELLOW}‚ö° Strategy:${NC}"
echo -e "     ‚Ä¢ Desktop = Base styles (no media query)"
echo -e "     ‚Ä¢ Tablet  = Overrides @media (max-width: XXXpx)"
echo -e "     ‚Ä¢ Mobile  = Overrides @media (max-width: XXXpx)"
echo ""
echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""

# Check arguments
if [ "$#" -ne 6 ]; then
  echo -e "${RED}‚ùå Missing arguments${NC}"
  echo ""
  echo "Usage: ./figma-merge <desktop-width> <desktop-test-id> <tablet-width> <tablet-test-id> <mobile-width> <mobile-test-id>"
  echo ""
  echo "Example:"
  echo "  ./figma-merge 1440px node-6055-2436-1762733564 960px node-6055-2654-1762712319 420px node-6055-2872-1762733537"
  echo ""
  echo "Arguments:"
  echo "  --desktop <width> <test-id>  : Desktop breakpoint (e.g., 1440px node-6055-2436-...)"
  echo "  --tablet  <width> <test-id>  : Tablet breakpoint (e.g., 960px node-6055-2654-...)"
  echo "  --mobile  <width> <test-id>  : Mobile breakpoint (e.g., 420px node-6055-2872-...)"
  exit 1
fi

DESKTOP_WIDTH="$1"
DESKTOP_ID="$2"
TABLET_WIDTH="$3"
TABLET_ID="$4"
MOBILE_WIDTH="$5"
MOBILE_ID="$6"

# Check Docker container is running
if ! docker ps | grep -q mcp-figma-v1; then
  echo -e "${YELLOW}‚ö†Ô∏è  Docker container not running${NC}"
  echo ""
  echo "Starting container..."
  docker-compose up -d

  # Wait for container to be ready
  echo "Waiting for startup (10s)..."
  sleep 10
fi

# Get absolute project path
PROJECT_ROOT="$(cd "$(dirname "$0")/.." && pwd)"

# Step 1: Split components for all 3 tests
echo -e "${CYAN}üî™ Step 1/4: Splitting Desktop components...${NC}"
docker exec mcp-figma-v1 node scripts/post-processing/component-splitter.js "/app/src/generated/export_figma/$DESKTOP_ID"
if [ $? -ne 0 ]; then
  echo -e "${RED}‚ùå Desktop split error${NC}"
  exit 1
fi

echo ""
echo -e "${CYAN}üî™ Step 2/4: Splitting Tablet components...${NC}"
docker exec mcp-figma-v1 node scripts/post-processing/component-splitter.js "/app/src/generated/export_figma/$TABLET_ID"
if [ $? -ne 0 ]; then
  echo -e "${RED}‚ùå Tablet split error${NC}"
  exit 1
fi

echo ""
echo -e "${CYAN}üî™ Step 3/4: Splitting Mobile components...${NC}"
docker exec mcp-figma-v1 node scripts/post-processing/component-splitter.js "/app/src/generated/export_figma/$MOBILE_ID"
if [ $? -ne 0 ]; then
  echo -e "${RED}‚ùå Mobile split error${NC}"
  exit 1
fi

# Step 2: Run responsive-merger.js in Docker
echo ""
echo -e "${GREEN}üöÄ Step 4/4: Starting Responsive Merger in Docker...${NC}"
echo ""

docker exec -e "PROJECT_ROOT=$PROJECT_ROOT" mcp-figma-v1 node scripts/responsive-merger.js \
  --desktop "$DESKTOP_WIDTH" "$DESKTOP_ID" \
  --tablet "$TABLET_WIDTH" "$TABLET_ID" \
  --mobile "$MOBILE_WIDTH" "$MOBILE_ID"

exit_code=$?

if [ $exit_code -eq 0 ]; then
  echo -e "${GREEN}‚úÖ Merge completed successfully${NC}"
else
  echo -e "${RED}‚ùå Merge error (code: $exit_code)${NC}"
  exit $exit_code
fi
