#!/bin/bash

# figma-validate - Validation visuelle Claude + corrections (~500 tokens)
# Usage: ./figma-validate node-9-2654-1730728354

set -e

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check arguments
if [ -z "$1" ]; then
  echo -e "${RED}‚ùå Test ID manquant${NC}"
  echo ""
  echo "Usage: ./figma-validate <test-id>"
  echo ""
  echo "Exemple:"
  echo "  ./figma-validate node-9-2654-1730728354"
  echo ""
  echo "Liste des tests disponibles:"
  ls -1 src/generated/tests/ 2>/dev/null | grep "^node-" | head -5
  exit 1
fi

TEST_ID="$1"
TEST_DIR="src/generated/tests/$TEST_ID"

# Check test directory exists
if [ ! -d "$TEST_DIR" ]; then
  echo -e "${RED}‚ùå Test non trouv√©: $TEST_DIR${NC}"
  echo ""
  echo "Tests disponibles:"
  ls -1 src/generated/tests/ 2>/dev/null | grep "^node-" | head -10
  exit 1
fi

# Check required files exist
REQUIRED_FILES=(
  "$TEST_DIR/Component-fixed.tsx"
  "$TEST_DIR/figma-screenshot.png"
  "$TEST_DIR/web-render.png"
)

for file in "${REQUIRED_FILES[@]}"; do
  if [ ! -f "$file" ]; then
    echo -e "${RED}‚ùå Fichier manquant: $file${NC}"
    echo ""
    echo "Le test semble incomplet. Avez-vous lanc√© figma-analyze?"
    exit 1
  fi
done

# Display info
echo -e "${GREEN}üîç Validation Claude pour: $TEST_ID${NC}"
echo ""
echo "Test directory: $TEST_DIR"
echo ""
echo "Fichiers √† comparer:"
echo "  - figma-screenshot.png (design Figma)"
echo "  - web-render.png (rendu web)"
echo ""
echo "Fichier √† corriger:"
echo "  - Component-fixed.tsx"
echo ""
echo -e "${YELLOW}‚ö†Ô∏è  Cette commande lance Claude Code et consomme ~500 tokens${NC}"
echo ""
read -p "Continuer? [y/N] " -n 1 -r
echo ""

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
  echo "Annul√©."
  exit 0
fi

# Launch Claude Code with prompt
echo ""
echo -e "${GREEN}üöÄ Lancement de Claude Code...${NC}"
echo ""

# Check if claude command exists
if ! command -v claude &> /dev/null; then
  echo -e "${RED}‚ùå Commande 'claude' non trouv√©e${NC}"
  echo ""
  echo "Installez Claude CLI: https://docs.anthropic.com/claude/docs"
  exit 1
fi

# Run Claude Code with custom prompt
claude code custo cli/prompts/validate-minimal.md test_id="$TEST_ID"

exit_code=$?

if [ $exit_code -eq 0 ]; then
  echo ""
  echo -e "${GREEN}‚úÖ Validation termin√©e${NC}"
else
  echo ""
  echo -e "${RED}‚ùå Erreur lors de la validation (code: $exit_code)${NC}"
  exit $exit_code
fi
