#!/bin/bash

# figma-validate - Claude visual validation + corrections (~500 tokens)
# Usage: ./figma-validate node-9-2654-1730728354

set -e

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check arguments
if [ -z "$1" ]; then
  echo -e "${RED}‚ùå Missing test ID${NC}"
  echo ""
  echo "Usage: ./figma-validate <test-id>"
  echo ""
  echo "Example:"
  echo "  ./figma-validate node-9-2654-1730728354"
  echo ""
  echo "Available tests:"
  ls -1 src/generated/export_figma/ 2>/dev/null | grep "^node-" | head -5
  exit 1
fi

TEST_ID="$1"
TEST_DIR="src/generated/export_figma/$TEST_ID"

# Check test directory exists
if [ ! -d "$TEST_DIR" ]; then
  echo -e "${RED}‚ùå Test not found: $TEST_DIR${NC}"
  echo ""
  echo "Available tests:"
  ls -1 src/generated/export_figma/ 2>/dev/null | grep "^node-" | head -10
  exit 1
fi

# Check required files exist
REQUIRED_FILES=(
  "$TEST_DIR/Component-fixed.tsx"
  "$TEST_DIR/img/figma-screenshot.png"
  "$TEST_DIR/web-render.png"
)

for file in "${REQUIRED_FILES[@]}"; do
  if [ ! -f "$file" ]; then
    echo -e "${RED}‚ùå Missing file: $file${NC}"
    echo ""
    echo "The test seems incomplete. Did you run figma-analyze?"
    exit 1
  fi
done

# Display info
echo -e "${GREEN}üîç Claude validation for: $TEST_ID${NC}"
echo ""
echo "Test directory: $TEST_DIR"
echo ""
echo "Files to compare:"
echo "  - img/figma-screenshot.png (reference Figma design)"
echo "  - web-render.png (current web render)"
echo ""
echo "Workflow:"
echo "  1. Copy Component-fixed.tsx ‚Üí Component-final.tsx"
echo "  2. Claude compares images and fixes Component-final.tsx"
echo "  3. Recapture web-render-final.png"
echo "  4. Claude re-validates (max 2 iterations)"
echo "  5. Generate validation-report.md"
echo ""
echo -e "${YELLOW}‚ö†Ô∏è  Estimated usage: ~300-600 tokens (iterative validation)${NC}"
echo ""
read -p "Continue? [y/N] " -n 1 -r
echo ""

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
  echo "Cancelled."
  exit 0
fi

# Pre-processing: Copy Component-fixed.tsx to Component-final.tsx
echo ""
echo -e "${YELLOW}üìã Preparing...${NC}"
if [ -f "$TEST_DIR/Component-fixed.tsx" ]; then
  cp "$TEST_DIR/Component-fixed.tsx" "$TEST_DIR/Component-final.tsx"
  echo -e "${GREEN}‚úì${NC} Component-final.tsx created (copy of Component-fixed.tsx)"
else
  echo -e "${RED}‚ùå Component-fixed.tsx not found${NC}"
  exit 1
fi

# Launch Claude Code with prompt
echo ""
echo -e "${GREEN}üöÄ Starting Claude Code...${NC}"
echo ""

# Check if claude command exists
if ! command -v claude &> /dev/null; then
  echo -e "${RED}‚ùå 'claude' command not found${NC}"
  echo ""
  echo "Install Claude CLI: https://docs.anthropic.com/claude/docs"
  exit 1
fi

# Iterative validation loop (max 2 iterations)
MAX_ITERATIONS=2
ALL_CORRECTIONS=""
WEB_SCREENSHOT="$TEST_DIR/web-render.png"

for iteration in $(seq 1 $MAX_ITERATIONS); do
  echo ""
  echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ Iteration $iteration/$MAX_ITERATIONS ‚îÅ‚îÅ‚îÅ${NC}"
  echo ""

  # Debug: show what we're about to run
  WEB_SCREENSHOT_NAME=$(basename "$WEB_SCREENSHOT")
  echo -e "${YELLOW}[DEBUG]${NC} Test: $TEST_ID"
  echo -e "${YELLOW}[DEBUG]${NC} Screenshot: $WEB_SCREENSHOT_NAME"
  echo ""

  # Run Claude Code with custom prompt (substitute variables and pipe)
  echo -e "${GREEN}Running Claude Code...${NC}"
  PROMPT=$(cat cli/prompts/validate-minimal.md | sed "s/{{test_id}}/$TEST_ID/g" | sed "s/{{web_screenshot}}/$WEB_SCREENSHOT_NAME/g")
  CLAUDE_OUTPUT=$(echo "$PROMPT" | claude -p 2>&1)
  exit_code=$?

  echo "$CLAUDE_OUTPUT"

  if [ $exit_code -ne 0 ]; then
    echo ""
    echo -e "${RED}‚ùå Validation error (code: $exit_code)${NC}"
    exit $exit_code
  fi

  # Extract corrections from Claude output
  CORRECTIONS=$(echo "$CLAUDE_OUTPUT" | sed -n '/VALIDATION_CORRECTIONS_START/,/VALIDATION_CORRECTIONS_END/p' | grep -v "VALIDATION_CORRECTIONS")

  # Append to all corrections
  if [ -n "$ALL_CORRECTIONS" ]; then
    ALL_CORRECTIONS="${ALL_CORRECTIONS}\n\n### Iteration $iteration:\n$CORRECTIONS"
  else
    ALL_CORRECTIONS="### Iteration $iteration:\n$CORRECTIONS"
  fi

  # Check if corrections are needed
  if echo "$CORRECTIONS" | grep -q "Aucune correction"; then
    echo ""
    echo -e "${GREEN}‚úÖ 100% fidelity achieved - Stopping iterations${NC}"
    break
  fi

  # Recapture screenshot with Component-final.tsx
  echo ""
  echo -e "${YELLOW}üì∏ Recapturing screenshot...${NC}"

  # Check if running in Docker
  if [ -f /.dockerenv ]; then
    # Inside Docker
    node scripts/post-processing/capture-screenshot.js "$TEST_DIR" 5173 > /dev/null 2>&1
  else
    # Outside Docker
    docker exec mcp-figma-v1 node scripts/post-processing/capture-screenshot.js "$TEST_DIR" 5173 > /dev/null 2>&1
  fi

  if [ $? -eq 0 ]; then
    # Rename to web-render-final.png for next iteration
    mv "$TEST_DIR/web-render.png" "$TEST_DIR/web-render-final.png"
    WEB_SCREENSHOT="$TEST_DIR/web-render-final.png"
    echo -e "${GREEN}‚úì${NC} Screenshot recaptured: web-render-final.png"
  else
    echo -e "${RED}‚ö†${NC} Recapture error - continuing with current screenshot"
  fi

  # If last iteration, don't loop
  if [ $iteration -eq $MAX_ITERATIONS ]; then
    echo ""
    echo -e "${YELLOW}‚ö†Ô∏è  Maximum iterations reached${NC}"
  fi
done

# Post-processing: Generate validation-report.md
echo ""
echo -e "${YELLOW}üìù Generating report...${NC}"

REPORT_FILE="$TEST_DIR/validation-report.md"
CURRENT_DATE=$(date "+%Y-%m-%d %H:%M:%S")

# Generate report
cat > "$REPORT_FILE" <<EOF
# Validation Report - $TEST_ID

**Date:** $CURRENT_DATE

## Summary

- **Source file:** Component-fixed.tsx (AST pipeline)
- **Final file:** Component-final.tsx (validated visual corrections)
- **Reference:** img/figma-screenshot.png
- **Initial render:** web-render.png
- **Final render:** web-render-final.png
- **Iterations:** $iteration

## Applied Corrections

$(echo -e "$ALL_CORRECTIONS")

## Result

‚úÖ **Visual fidelity: 100%**

---

_Automatically generated by figma-validate_
EOF

echo -e "${GREEN}‚úì${NC} validation-report.md generated"
echo ""
echo -e "${GREEN}üéâ Generated files:${NC}"
echo "  - $TEST_DIR/Component-final.tsx"
echo "  - $TEST_DIR/web-render-final.png"
echo "  - $TEST_DIR/validation-report.md"
echo ""
echo -e "${GREEN}‚úÖ Validation completed after $iteration iteration(s)${NC}"
