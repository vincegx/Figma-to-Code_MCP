#!/bin/bash

# figma-analyze - G√©n√®re un test complet depuis une URL Figma (0 tokens)
# Usage: ./figma-analyze "https://www.figma.com/design/abc?node-id=9-2654"

set -e

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check arguments
if [ -z "$1" ]; then
  echo -e "${RED}‚ùå URL Figma manquante${NC}"
  echo ""
  echo "Usage: ./figma-analyze \"https://www.figma.com/design/FILE_ID?node-id=X-Y\""
  echo ""
  echo "Exemple:"
  echo "  ./figma-analyze \"https://www.figma.com/design/abc123?node-id=9-2654\""
  exit 1
fi

FIGMA_URL="$1"

# Check Docker container is running
if ! docker ps | grep -q mcp-figma-v1; then
  echo -e "${YELLOW}‚ö†Ô∏è  Container Docker non lanc√©${NC}"
  echo ""
  echo "Lancement du container..."
  docker-compose up -d

  # Wait for container to be ready
  echo "Attente du d√©marrage (10s)..."
  sleep 10
fi

# Check .env file exists
if [ ! -f .env ]; then
  echo -e "${RED}‚ùå Fichier .env manquant${NC}"
  echo ""
  echo "Cr√©ez un fichier .env avec:"
  echo "  FIGMA_API_KEY=your_figma_api_key"
  echo ""
  echo "Obtenez votre cl√© API sur: https://www.figma.com/developers/api#access-tokens"
  exit 1
fi

# Get absolute project path for MCP (runs on host, not in Docker)
PROJECT_ROOT="$(cd "$(dirname "$0")/.." && pwd)"

# Run figma-cli.js in Docker
echo -e "${GREEN}üöÄ Lancement de figma-analyze dans Docker...${NC}"
echo ""

docker exec -e "PROJECT_ROOT=$PROJECT_ROOT" mcp-figma-v1 node scripts/figma-cli.js "$FIGMA_URL"

exit_code=$?

if [ $exit_code -eq 0 ]; then
  echo -e "${GREEN}‚úÖ Analyse termin√©e avec succ√®s${NC}"
else
  echo -e "${RED}‚ùå Erreur lors de l'analyse (code: $exit_code)${NC}"
  exit $exit_code
fi
