#!/bin/bash

set -e

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Display banner
clear
echo ""
echo -e "${MAGENTA}"
cat << "EOF"
8"""" 8  8""""8 8""8""8 8""""8                                            8" 8""8""8 8""""8 8""""8 "8
8     8  8    " 8  8  8 8    8    eeeee eeeee    eeee eeeee eeeee eeee    8  8  8  8 8    " 8    8  8
8eeee 8e 8e     8e 8  8 8eeee8      8   8  88    8  8 8  88 8   8 8       8  8e 8  8 8e     8eeee8  8
88    88 88  ee 88 8  8 88   8      8e  8   8    8e   8   8 8e  8 8eee    8  88 8  8 88     88      8
88    88 88   8 88 8  8 88   8      88  8   8    88   8   8 88  8 88      8  88 8  8 88   e 88      8
88    88 88eee8 88 8  8 88   8      88  8eee8    88e8 8eee8 88ee8 88ee    8e 88 8  8 88eee8 88     e8
EOF
echo -e "${NC}"

echo -e "${BOLD}${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BOLD}  MCP Figma to Code V1${NC} - React component generator with 100% visual fidelity"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo -e "  ${CYAN}ğŸ“¦ Features:${NC}"
echo -e "     â€¢ Parallel MCP extraction (design, screenshot, variables, metadata)"
echo -e "     â€¢ AST pipeline with 9 transformations (fonts, layout, SVG, CSS vars...)"
echo -e "     â€¢ Automatic chunking for complex designs (>25k tokens)"
echo -e "     â€¢ Visual validation (Figma vs Web render)"
echo -e "     â€¢ Production-ready React + Tailwind + CSS generation"
echo ""
echo -e "  ${YELLOW}âš¡ Performance:${NC}"
echo -e "     â€¢ Simple design: ~10-15s"
echo -e "     â€¢ Complex design: ~25-40s"
echo -e "     â€¢ Optimized write tool (84% faster)"
echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Check arguments
if [ -z "$1" ]; then
  echo -e "${RED}âŒ Missing Figma URL${NC}"
  echo ""
  echo "Usage: ./figma-analyze \"https://www.figma.com/design/FILE_ID?node-id=X-Y\""
  echo ""
  echo "Example:"
  echo "  ./figma-analyze \"https://www.figma.com/design/abc123?node-id=9-2654\""
  exit 1
fi

FIGMA_URL="$1"

# Check Docker container is running
if ! docker ps | grep -q mcp-figma-v1; then
  echo -e "${YELLOW}âš ï¸  Docker container not running${NC}"
  echo ""
  echo "Starting container..."
  docker-compose up -d

  # Wait for container to be ready
  echo "Waiting for startup (10s)..."
  sleep 10
fi

# Get absolute project path for MCP (runs on host, not in Docker)
PROJECT_ROOT="$(cd "$(dirname "$0")/.." && pwd)"

# Run figma-cli.js in Docker
echo -e "${GREEN}ğŸš€ Starting figma-analyze in Docker...${NC}"
echo ""

docker exec -e "PROJECT_ROOT=$PROJECT_ROOT" mcp-figma-v1 node scripts/figma-cli.js "$FIGMA_URL"

exit_code=$?

if [ $exit_code -eq 0 ]; then
  echo -e "${GREEN}âœ… Analysis completed successfully${NC}"
else
  echo -e "${RED}âŒ Analysis error (code: $exit_code)${NC}"
  exit $exit_code
fi
