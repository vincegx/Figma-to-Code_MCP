#!/bin/bash

# Reprocess all Figma exports with progress bar
# Usage: ./cli/figma-reprocess-all [--clean]

CLEAN_FLAG=""
[ "$1" == "--clean" ] && CLEAN_FLAG="--clean"

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# Get export folders
EXPORT_DIR="src/generated/export_figma"
FOLDERS=$(ls -1 "$EXPORT_DIR" | grep "^node-" || true)

if [ -z "$FOLDERS" ]; then
  echo -e "${RED}❌ No export folders found${NC}"
  exit 1
fi

# Count and display
TOTAL=$(echo "$FOLDERS" | wc -l | xargs)
echo ""
echo -e "${CYAN}🔄 Found ${BOLD}$TOTAL${NC}${CYAN} export(s) to reprocess${NC}"
[ -n "$CLEAN_FLAG" ] && echo -e "${YELLOW}✨ Clean mode enabled${NC}"
echo ""

# Show list
echo -e "${BOLD}Exports found:${NC}"
echo "$FOLDERS" | nl -w2 -s'. '
echo ""

# Confirmation with exclusion option
echo -e "${YELLOW}Options:${NC}"
echo -e "  ${GREEN}y${NC}  - Process all"
echo -e "  ${RED}n${NC}  - Cancel"
echo -e "  ${CYAN}e${NC}  - Process all except some (exclude mode)"
echo ""
echo -e "${YELLOW}Choice [y/N/e]:${NC} "
read -r CONFIRM

if [[ ! "$CONFIRM" =~ ^[YyEe]$ ]]; then
  echo -e "${RED}❌ Cancelled${NC}"
  exit 0
fi

# Exclusion mode
EXCLUDED=""
if [[ "$CONFIRM" =~ ^[Ee]$ ]]; then
  echo ""
  echo -e "${CYAN}Enter node-ids to exclude (comma-separated or space-separated):${NC}"
  echo -e "${CYAN}Example: node-108-14588-1763149866,node-120-14177-1763410777${NC}"
  echo ""
  read -r EXCLUDE_INPUT

  if [ -n "$EXCLUDE_INPUT" ]; then
    # Convert commas to spaces for easier parsing
    EXCLUDED=$(echo "$EXCLUDE_INPUT" | tr ',' ' ')
    echo ""
    echo -e "${YELLOW}📌 Will exclude:${NC}"
    for excl in $EXCLUDED; do
      echo -e "  ${RED}✗${NC} $excl"
    done
  fi
fi

# Filter logs to show only important ones
filter_logs() {
  grep -E "(✓|✅|❌|⚠️.*extracted|⚠️.*failed|Error:|PHASE)" || true
}

echo ""
echo -e "${BOLD}${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BOLD}  Processing Exports${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

CURRENT=0
SUCCESS=0
FAILED=0

# Create temp log file
TEMP_LOG=$(mktemp)
FAILED_LOG=$(mktemp)

echo "$FOLDERS" | while read -r EXPORT_ID; do
  # Check if this ID should be excluded
  SKIP=0
  if [ -n "$EXCLUDED" ]; then
    for excl in $EXCLUDED; do
      if [ "$EXPORT_ID" = "$excl" ]; then
        SKIP=1
        break
      fi
    done
  fi

  if [ $SKIP -eq 1 ]; then
    echo -e "${YELLOW}⊘ Skipped:${NC} ${EXPORT_ID}"
    continue
  fi

  CURRENT=$((CURRENT + 1))

  # Simple compact header for each export
  echo ""
  echo -e "${CYAN}[${CURRENT}/${TOTAL}]${NC} ${BOLD}${EXPORT_ID}${NC}"

  # Run reprocessing and capture output + errors
  OUTPUT=$(docker exec mcp-figma-v1 node scripts/figma-export-reprocess.js "$EXPORT_ID" $CLEAN_FLAG 2>&1)
  EXIT_CODE=$?

  # Filter and display logs
  echo "$OUTPUT" | filter_logs

  # Check for errors in output
  ERROR_MSG=$(echo "$OUTPUT" | grep -E "(❌|Error:)")

  if [ $EXIT_CODE -eq 0 ] && [ -z "$ERROR_MSG" ]; then
    echo -e "${GREEN}✓ Success${NC}"
    SUCCESS=$((SUCCESS + 1))
  else
    echo -e "${RED}✗ Failed${NC}"
    FAILED=$((FAILED + 1))
    echo "$EXPORT_ID" >> "$FAILED_LOG"
  fi

  echo -e "${BLUE}─────────────────────────────────────────────────────${NC}"
done

echo ""

# Final summary
echo ""
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BOLD}${GREEN}✅ Batch Processing Complete${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""
echo -e "  ${CYAN}Total:${NC}   ${BOLD}$TOTAL${NC}"
echo -e "  ${GREEN}Success:${NC} ${BOLD}$SUCCESS${NC}"

if [ $FAILED -gt 0 ]; then
  echo -e "  ${RED}Failed:${NC}  ${BOLD}$FAILED${NC}"
  echo ""
  echo -e "${RED}${BOLD}Failed nodes:${NC}"

  if [ -f "$FAILED_LOG" ]; then
    while read -r node_id; do
      echo -e "  ${RED}✗${NC} $node_id"
    done < "$FAILED_LOG"
  fi

  echo ""
  echo -e "${CYAN}Tip: Reprocess individually with:${NC}"
  echo -e "  ${CYAN}./cli/figma-reprocess <node-id> --clean${NC}"
fi

echo ""

# Cleanup
rm -f "$TEMP_LOG" "$FAILED_LOG"
