#!/bin/bash

set -e

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Display banner
clear
echo ""
echo -e "${MAGENTA}"
cat << "EOF"
8"""" 8  8""""8 8""8""8 8""""8
8     8  8    " 8  8  8 8    8    eeeee eeeee eeeee eeeee eeeee  eeee  eeee  eeee  eeeee eeeee
8eeee 8e 8e     8e 8  8 8eeee8      8   8  88 8   8 8   8 8   8 8   8 8   8 8   8 8   8 8   8
88    88 88  ee 88 8  8 88   8      8e  8   8 8eee8 8eee8 8eee8 8eee8 8e    8e    8eee8 8e  8
88    88 88   8 88 8  8 88   8      88  8   8 88    88    88    88    88    88    88    88  8
88    88 88eee8 88 8  8 88   8      88  8eee8 88    88    88    88    88eee 88eee 88    88ee8
EOF
echo -e "${NC}"

echo -e "${BOLD}${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BOLD}  Figma Export Reprocessor${NC} - Regenerate files without MCP calls"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo -e "  ${CYAN}ðŸ”„ What it does:${NC}"
echo -e "     â€¢ Re-runs Phase 2: AST transformations + reports"
echo -e "     â€¢ Re-runs Phase 3: Web screenshot capture"
echo -e "     â€¢ Re-runs Phase 4: Component splitting + dist package"
echo -e "     â€¢ Uses existing Component.tsx (no MCP calls)"
echo ""
echo -e "  ${YELLOW}ðŸ’¡ Use cases:${NC}"
echo -e "     â€¢ Modified AST transforms and want to re-apply them"
echo -e "     â€¢ Need to regenerate clean version with --clean flag"
echo -e "     â€¢ Screenshot failed and want to retry"
echo -e "     â€¢ Update reports after code changes"
echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Check arguments
if [ -z "$1" ]; then
  echo -e "${RED}âŒ Missing export ID${NC}"
  echo ""
  echo -e "  ${BOLD}Usage:${NC}"
  echo -e "    ${CYAN}./cli/figma-reprocess <export-id> [--clean]${NC}"
  echo ""
  echo -e "  ${BOLD}Examples:${NC}"
  echo -e "    ${CYAN}./cli/figma-reprocess node-9-2654-1735689600${NC}"
  echo -e "    ${CYAN}./cli/figma-reprocess node-9-2654-1735689600 --clean${NC}"
  echo ""
  echo -e "  ${BOLD}Find export IDs:${NC}"
  echo -e "    ${CYAN}ls src/generated/export_figma/${NC}"
  echo ""
  exit 1
fi

EXPORT_ID=$1
CLEAN_FLAG=""

if [ "$2" == "--clean" ]; then
  CLEAN_FLAG="--clean"
fi

echo -e "${CYAN}ðŸ“‹ Export ID:${NC} ${BOLD}${EXPORT_ID}${NC}"
if [ -n "$CLEAN_FLAG" ]; then
  echo -e "${CYAN}âœ¨ Clean Mode:${NC} ${BOLD}Enabled${NC} (production version will be generated)"
else
  echo -e "${CYAN}âœ¨ Clean Mode:${NC} Disabled (use --clean to enable)"
fi
echo ""

# Check if Docker is running
if command -v docker &> /dev/null && docker ps &> /dev/null; then
  echo -e "${GREEN}âœ“ Docker is running${NC}"
  DOCKER_CMD="docker exec mcp-figma-v1"
else
  echo -e "${YELLOW}âš  Docker not running, using host environment${NC}"
  DOCKER_CMD=""
fi

echo ""
echo -e "${BOLD}${MAGENTA}ðŸš€ Starting reprocessing...${NC}"
echo ""

# Execute reprocessing
if [ -n "$DOCKER_CMD" ]; then
  $DOCKER_CMD node scripts/figma-export-reprocess.js "$EXPORT_ID" $CLEAN_FLAG
else
  node scripts/figma-export-reprocess.js "$EXPORT_ID" $CLEAN_FLAG
fi

# Success message
echo ""
echo -e "${GREEN}${BOLD}âœ… Reprocessing complete!${NC}"
echo ""
echo -e "  ${CYAN}View in dashboard:${NC}"
echo -e "    ${BLUE}http://localhost:5173/export_figma/${EXPORT_ID}${NC}"
echo ""
